#  zk-SNARKs 如何改进 Binance 的储备金证明系统

Chaineye rust binance por 教程，供想要学习的小伙伴学习。

推特：@seek_web3

Chainey 社群： 官网 chaineye.info | Chaineye Rust 教程 | 微信: LGZAXE, 加微信之后拉各社群 

所有代码和教程开源在github: https://github.com/0xchaineye/chaineye-binance-por

-----------------------------------------------------------------------------------------------------------------------------------------------------------

## 1.主要要点

- 2022 年 11 月，币安发布了使用 Merkle 树密码学的储备证明系统，允许用户验证其持有量。

- Binance 现在通过实施 zk-SNARKs（一种零知识证明形式）改进了其解决方案。

- 用户现在可以以私密和安全的方式检查每个账户的总净余额是否为非负数，以及所有用户资产是否属于币安声称的用户资产总净余额的一部分。

深入了解币安新的储备金证明解决方案。结合 zk-SNARKs 和 Merkle 树信息，它为用户提供了一种新的和改进的方式来验证 Binance 储备的状态。

在过去的几个月里，币安的开发团队一直在努力构建先进的偿付能力证明解决方案。在 FTX 崩溃后席卷整个行业的信任危机中，此类工具对于集中式加密货币交易所至关重要。存储在 Binance 上的用户资金以 1:1 的比例加上准备金得到支持，找到一种向公众无缝证明这一点的方法已成为 Binance 恢复行业信任计划的重要组成部分。 

2022 年 11 月，我们发布了使用 Merkle 树加密技术的储备证明系统，允许用户验证他们在 Binance 上的持有量。虽然 Binance 的用户资金透明度推动取得了进步，但该解决方案的初始设计有两个缺点：

1.为了保护用户隐私，Merkle 证明中的叶子节点代表了用户持有的哈希值——因此，Merkle 根不能反映其叶子节点余额信息的总和。

[![merkle_tree_1](https://github.com/0xchaineye/chaineye-binance-por/blob/main/images/merkle_tree_1.png)](https://github.com/0xchaineye/chaineye-binance-por/)

正在验证其准备金的实体可能会在树中某处的假账户下添加负余额，以使所需准备金总额看起来更小。下图来自 Vitalik Buterin 的博客，显示了这种恶意 Merkle 树的示例（尽管在这种情况下，根反映了所有叶节点余额的总和，这可能会引入隐私问题）。

[![merkle_tree_2](https://github.com/0xchaineye/chaineye-binance-por/blob/main/images/merkle_tree_2.png)](https://github.com/0xchaineye/chaineye-binance-por/)

我们现在有一个解决方案可以弥补这些缺点，从而加强 Binance 的储备证明系统。依靠零知识证明协议zk-SNARKs，我们可以证明：

1. Merkle 树的所有叶节点都对 Binance 声称的每项资产的总用户余额做出了贡献。

2. Merkle 树中没有包含负总净余额（用户持有的所有资产的总美元价值）的用户。


## 2.关于负余额和绩效的一句话

由于币安提供保证金、加密贷款和期货交易产品，因此每个用户的每个加密资产余额可能由资产和负债组成。用户在特定加密资产上的余额可以为负，但他们在所有加密资产上的总净余额不应为负（因为所有贷款都是完全抵押的）。

在这个假设场景中，假设 Alice 向 Binance 存入了 10,000 BUSD，然后使用 4,000 BUSD 作为抵押品借入 2 BNB（以 1 BNB = 1,000 BUSD 的利率，假设 Binance 总是过度抵押）。下表显示了爱丽丝的资产负债表。

[![table_1](https://github.com/0xchaineye/chaineye-binance-por/blob/main/images/table_1.png)](https://github.com/0xchaineye/chaineye-binance-por/)


如果 Alice 然后用 1 BNB 与 Bob（他也存入了 10,000 BUSD）交易 1,000 BUSD，交易匹配后他们的资产负债表将如下所示：

[![table_2](https://github.com/0xchaineye/chaineye-binance-por/blob/main/images/table_2.png)](https://github.com/0xchaineye/chaineye-binance-por/)


在这种情况下，Alice 的 BNB 余额将达到 -1，这不是 Merkle 树中的有效节点，并且只包含一种资产：BNB。但是，如果我们查看总净余额，Alice 仍为 10,000。

另一个挑战来自币安用户群的庞大规模。一个可行的解决方案必须为数千万用户生成用户证明和 zk-SNARK 证明，其中一些用户可能在我们的平台上持有超过 300 种加密资产。 

总而言之，我们希望在合理的时间范围内提供以下事实的证明：

1.每个币安用户的资产都是快照中显示的我们声明的用户总余额的一部分。用户可以使用区块链浏览器（例如用于以太坊钱包的Etherscan或用于 BNB Chain 钱包的BscScan ）来验证我们声称的总用户余额与Binance 控制的地址中持有的资产。

2.每个用户的总净余额都是非负的，这意味着币安没有创建负余额的虚拟账户来人为地减少我们已验证储备的规模。

## 3. 什么是 zk-SNARK

在我们深入研究解决方案的细节之前，先简要概述一下零知识证明机制。像 zk-SNARK 这样的零知识协议允许一方（证明者）向另一方（验证者）证明证明者已经在特定约束下使用特定输入准确地执行了特定计算，所有这些都无需公开输入。计算可能很耗时，但底层的数学机制可以帮助验证者快速、安全地评估证明。

证明者（Binance）首先定义一组它想要证明的计算约束。约束在可以用高级编程语言（在我们的例子中是gnark的分支版本）表达的电路中定义。

然后，证明者执行繁重的计算，散列所有用户的 ID 和资产负债表，并生成满足先前设定的约束的计算证明。为此，它使用计算跟踪（见证）和公共或私人输入。 

验证者（用户）获取证明并使用电路的公共输入对其进行验证，以使自己确信计算已在满足所有约束的情况下准确执行。与证明时间相比，验证计算花费的时间极短。如果证明者不在预定义电路上生成证明，则无法产生有效证明来通过验证。


## 4. 币安的解决方案

升级后的储备证明解决方案的基本构建块仍然是 Merkle 树。对于上面的示例，它看起来像这样：


[![binace-proof](https://github.com/0xchaineye/chaineye-binance-por/blob/main/images/binace-proof.png)](https://github.com/0xchaineye/chaineye-binance-por/)

除了 Merkle 树之外，我们还维护一个全局状态，该状态表示每个 Binance 客户持有的每个资产的总净余额列表。

为了证明我们的储备，我们将为 Merkle 树的构建生成 zk-SNARK 证明。对于每个用户的余额集——Merkle 树的叶节点——我们的电路将确保：

- 该用户的每项资产余额都包含在上述全局状态列表中。
- 用户总净余额不为负。 
- Merkle 树根的变化在将本次用户信息更新到叶节点哈希后生效。

在每次证明我们的储量时，我们都会发布：

1. Merkle 证明：每个用户的哈希值（对于 Alice，在上图中用蓝色节点表示）。

2. zk-SNARK 证明和所有用户电路的 公共输入（每个资产和Merkle 根的总净余额列表的哈希值） 。

通过验证 Merkle 证明，用户可以确保他们的资产负债表包含在 Merkle 树根中。通过验证 zk-SNARK 证明，用户可以确保 Merkle 树的构造满足电路中定义的约束。

该解决方案的安全性在很大程度上依赖于证明密钥和验证密钥的设置。我们正在研究密钥的分散设置。在谈到现有的去中心化可信设置仪式时，以太坊仪式提供了一个很好的例子。我们非常接近拥有一个 MPC 解决方案来使设置变得不可信。

## 5.表现

考虑到应包括其余额的 Binance 用户数量，无法获得一次涵盖所有用户的 Merkle 树构造的单一证明。一个解决方案是将用户分成批次，每批 864 个，以便拥有更小规模的电路和并行的证明程序。

对于包含 864 个用户的批处理，每个用户拥有 350 个不同的资产，假设每个资产余额都在 [0, 2^64-1] 范围内。32核128GB服务器，zk证明生成时间约110秒，证明验证时间小于1毫秒。 

Binance 将同时启动 1000 个证明者，以便在 2 小时内为所有账户生成证明。这个证明者服务器一小时的成本约为 0.56 美元，因此生成覆盖所有用户的所有 zk 证明的总成本约为 1000 美元。

## 6.结论

我们将在随后的储备证明公告中为这个新解决方案生成的用户提供第一次迭代证明。此外，我们开源了我们的用户数据处理器、证明者、电路和验证者，以便每个与我们依赖相同模型的中心化交易所都可以轻松地为他们的用户和资产生成证明。 

我们希望这将有助于将数字资产行业的透明度提升到一个新的水平。我们也在努力实现Vitalik 博客中提到的解决方案，以实现更好的性能，这将使我们能够以更低的成本更频繁地提供证明。



